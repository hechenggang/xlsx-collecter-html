<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>简单采集 - 后台管理</title>
    <!-- import CSS -->
    <!-- <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css"> -->
    <link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/element-ui/2.15.0/theme-chalk/index.min.css">
</head>

<body>
    <div id="app">
        <div v-if="status.loading" class="fixed_full flex_center bg_01 z_top">
            <div class="lds-spinner">
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
            </div>
        </div>


        <!-- 主容器 -->
        <el-container style="border: 1px solid #eee;">

            <el-container>
                <el-header class="flex_between">
                    <div>
                        <el-button @click="load_forms">刷新</el-button>
                    </div>
                    <div>
                        <el-button @click="newFormVisible = true">新建表单</el-button>
                    </div>

                    <el-dialog title="新建表单" :visible.sync="newFormVisible">
                        <el-form >
                            <el-form-item label="表单标题" >
                                <el-input v-model="newFormTitle"  auto-complete="off"></el-input>
                            </el-form-item>

                            <el-form-item label="表单模板" >
                                <el-upload
                                    drag
                                    ref="upload"
                                    :auto-upload="false"
                                    >
                                    <i class="el-icon-upload"></i>
                                    <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
                                    <div class="el-upload__tip" slot="tip">只能上传.xlsx文件，且不超过500kb</div>
                                    </el-upload>
                            </el-form-item>
                            
                        </el-form>
                        <div slot="footer" class="dialog-footer">
                            <el-button @click="newFormVisible = false">取 消</el-button>
                            <el-button type="primary" @click="newFormVisible = false,doNewForm()">确 定</el-button>
                        </div>
                    </el-dialog>

                    <el-dialog title="导入用户" :visible.sync="importFormUserVisible">
                        <el-form >
                            
                            <el-form-item label="用户模板" >
                                <el-upload
                                    drag
                                    ref="upload_user"
                                    :auto-upload="false"
                                    >
                                    <i class="el-icon-upload"></i>
                                    <div class="el-upload__text">将文件拖到此处，或<em>点击上传</em></div>
                                    <div class="el-upload__tip" slot="tip">
                                        <a :href="api.form_users_xlsx_demo">下载模板</a>
                                    </div>
                                    </el-upload>
                            </el-form-item>
                            
                        </el-form>
                        <div slot="footer" class="dialog-footer">
                            <el-button @click="importFormUserVisible = false">取 消</el-button>
                            <el-button type="primary" @click="importFormUserVisible = false,doImportFormUser()">确 定</el-button>
                        </div>
                    </el-dialog>
                </el-header>

                <el-main style="padding:5px;">
                    <el-table height="80vh" :data="forms.data" border style="width: 100%">
                        <el-table-column align="center" label="表单标题">
                            
                            <template slot-scope="scope">
                                <a target="_blank" :href="'/form.html?form_id='+scope.row.form_id"  >{{scope.row.form_title}}</a>
                            </template>
                        </el-table-column>
                        <el-table-column align="center" prop="form_id" label="表单标识"> </el-table-column>
                        <el-table-column align="center" prop="create_at" label="表单创建时间"> </el-table-column>

                        <el-table-column align="center" fixed="right" label="操作">
                            <template slot-scope="scope">
                                <el-button @click="importFormUserVisible = true, thisRow=scope.row" >导入用户</el-button>
                            </template>
                        </el-table-column>

                    </el-table>


                </el-main>
            </el-container>
        </el-container>
    </div>
</body>

<!-- import Vue before Element -->
<!-- <script src="https://unpkg.com/vue/dist/vue.js"></script> -->
<script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/vue/2.6.14/vue.min.js"></script>
<!-- import JavaScript -->
<!-- <script src="https://unpkg.com/element-ui/lib/index.js"></script> -->
<script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/element-ui/2.15.0/index.min.js"></script>
<!-- <script src="https://unpkg.com/axios/dist/axios.min.js"></script> -->
<script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/axios/0.21.1/axios.min.js"></script>
<script>
    // 获取 管理凭证
    // 获取 所有已创建项目
    // 提供 新建表单，管理表单
    // http://127.0.0.1:5500/admin.html?code=cc9ebe6c6292e340936f098cf81e8f2ee21d3cfc5c528eb29479f23dd70ecf7d-cc244092a6c77f800141eceaea9b7271bddab4932f391272840a8d710864ba1b
    const x_api_code = window.location.href.split("code=")[1]
    if (x_api_code==undefined){
        window.location.assign("https://account.imhcg.cn/to/4798278f12f02838887fcf116c8e7d1b")
    }
    console.log("code:",x_api_code)
    new Vue({
        el: '#app',
        mounted: function () {
            this.load_forms();
        },
        data: function () {
            return {
                newFormVisible:false,
                newFormTitle:"",
                importFormUserVisible:false,
                thisRow:[],

                status: {
                    loading: false,
                    
                },
                
                api: {
                    forms: "https://xlsx-collecter-api.imhcg.cn/api/user/forms",
                    xlsx_create: "https://xlsx-collecter-api.imhcg.cn/api/xlsx/",
                    form_users_import:(form_id)=>{
                        return `https://xlsx-collecter-api.imhcg.cn/api/xlsx/${form_id}/users`
                    },
                    form_users_xlsx_demo:"https://xlsx-collecter-api.imhcg.cn/static/file/xlsx/users.xlsx"
                },
                forms: {
                    data: [],
                }
            }
        },
        methods: {
            add(a, b) {
                this.status.offset = Number(a) + Number(b);
                return this.status.offset;
            },
            sub(a, b) {
                this.status.offset = Number(a) - Number(b)
                if (this.status.offset < 0){
                    this.message("已经是第一页", "warning");
                    this.status.offset = 0;
                    return this.status.offset;
                }else{
                    return this.status.offset;
                }
            },
            getDate(ts){
                return new Date(ts*1000).toLocaleString();
            },
           
            http_get: function (url, callback) {
                this.status.loading = true;
                console.log("开始请求数据 <- ", url);
                axios
                    .get(url, {
                        headers: {
                            "x-api-code": x_api_code,
                        },
                    })
                    .then((response) => {
                        callback(response);
                    })
                    .catch((error) => {
                        if (error) {
                            console.log("error:", error);
                            if (error.response.status in { 401: "", 403: "" }) {
                                delete localStorage["x-api-code"];
                                location.assign("/admin.html");
                            }
                            else {
                                alert("错误 " + error.response.status)
                            }
                        }
                    })
                    .finally(() => {
                        this.status.loading = false;
                        console.log("请求完成 <- ", url);
                    });
            },
            http_post_json: function (url, data, callback) {
                this.status.loading = true;
                console.log("开始请求数据 <- ", url);
                axios({
                    method: 'post',
                    url: url,
                    data: data,
                    headers: {
                        "x-api-code": x_api_code,
                        "content-type": "application/json",
                    }
                })
                    .then((response) => {
                        callback(response);
                    })
                    .catch((error) => {
                        if (error) {
                            console.log("error:", error);
                            if (error.response.status in { 401: "", 403: "" }) {
                                delete localStorage["x-api-code"];
                                location.assign("/admin.html");
                            }
                            else {
                                alert("错误 " + error.response.status)
                            }
                        }
                    })
                    .finally(() => {
                        this.status.loading = false;
                        console.log("请求完成 <- ", url);
                    });
            },
            after_load_forms (response)  {
                console.log(this);
                let temp = Array();
                response.data.forms.forEach((e)=>{
                    console.log(this,this.getDate(e["create_at"]),e);
                    e["create_at"] = this.getDate(e["create_at"]);
                    temp.push(e);
                })
                this.forms.data = temp;
                console.log(temp);
                
            },
            load_forms() {
                this.http_get(this.api.forms,this.after_load_forms);
            },
            
            message(text, type) {
                this.$message({
                    showClose: true,
                    message: text,
                    type: type
                });
            },
            doNewForm(){
                let file = this.$refs.upload.uploadFiles[0].raw;
                
                console.log(this.newFormTitle,file);
                var formData = new FormData();
                formData.append("file", file);
                formData.append("title", this.newFormTitle);
                axios.post(this.api.xlsx_create, formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data',
                        "x-api-code": x_api_code,
                    }
                }).then((resp)=>{
                    console.log(resp);
                    this.message("创建成功", "success");
                    this.load_forms();
                })
            },
            doImportFormUser(){
                let file = this.$refs.upload_user.uploadFiles[0].raw;
                console.log(file,this.thisRow);
                let form_id = this.thisRow.form_id;

                var formData = new FormData();
                formData.append("file", file);
                axios.post(this.api.form_users_import(form_id), formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data',
                        "x-api-code": x_api_code,
                    }
                }).then((resp)=>{
                    console.log(resp);
                    this.message("创建成功", "success");
                    this.load_forms();
                })
            },

        }
    })
</script>

<style>
    p {
        color: #72767b;
    }
    .el-header {
        background-color: #B3C0D1;
        color: #333;
        line-height: 60px;
    }

    .el-aside {
        color: #333;
    }

    .lds-spinner {
        display: inline-block;
        position: relative;
        width: 40px;
        height: 40px;
    }

    .lds-spinner div {
        transform-origin: 20px 20px;
        animation: lds-spinner 1.2s linear infinite;
    }

    .lds-spinner div:after {
        content: " ";
        display: block;
        position: absolute;
        top: 1.5px;
        left: 18.5px;
        width: 3px;
        height: 9px;
        border-radius: 10%;
        background: #1A2B3C;
    }

    .lds-spinner div:nth-child(1) {
        transform: rotate(0deg);
        animation-delay: -1.1s;
    }

    .lds-spinner div:nth-child(2) {
        transform: rotate(30deg);
        animation-delay: -1s;
    }

    .lds-spinner div:nth-child(3) {
        transform: rotate(60deg);
        animation-delay: -0.9s;
    }

    .lds-spinner div:nth-child(4) {
        transform: rotate(90deg);
        animation-delay: -0.8s;
    }

    .lds-spinner div:nth-child(5) {
        transform: rotate(120deg);
        animation-delay: -0.7s;
    }

    .lds-spinner div:nth-child(6) {
        transform: rotate(150deg);
        animation-delay: -0.6s;
    }

    .lds-spinner div:nth-child(7) {
        transform: rotate(180deg);
        animation-delay: -0.5s;
    }

    .lds-spinner div:nth-child(8) {
        transform: rotate(210deg);
        animation-delay: -0.4s;
    }

    .lds-spinner div:nth-child(9) {
        transform: rotate(240deg);
        animation-delay: -0.3s;
    }

    .lds-spinner div:nth-child(10) {
        transform: rotate(270deg);
        animation-delay: -0.2s;
    }

    .lds-spinner div:nth-child(11) {
        transform: rotate(300deg);
        animation-delay: -0.1s;
    }

    .lds-spinner div:nth-child(12) {
        transform: rotate(330deg);
        animation-delay: 0s;
    }

    @keyframes lds-spinner {
        0% {
            opacity: 1;
        }

        100% {
            opacity: 0;
        }
    }

    .fixed_full {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }

    .flex_center {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-wrap: nowrap;
        flex-direction: column;
    }

    .flex_between {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: nowrap;
        flex-direction: row;
    }

    .z_top {

        z-index: 999;
    }
    .bg_01 {
        background-color: #ffffff95;
    }
</style>

</html>